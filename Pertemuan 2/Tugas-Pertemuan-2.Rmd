---
title: "Tugas Pertemuan 2"
author: "Zanira Husna G1401231097"
output:
  html_document: 
    toc: true
    toc_depth: 3
    toc_float: true
---

# Persiapan Data

## Library/Packages

```{r}
library("forecast")
library("graphics")
library("TTR")
library("TSA")
library("ggplot2")
```

## Impor Data

```{r}
library(readxl)
data <- read_xlsx("C:\\Users\\ZANIRA\\Downloads\\laporan_iklim_harian-250831182901.xlsx", skip = 258, n_max = 125)

# Ganti nama kolom 1 sampai 4
colnames(data)[1:4] <- c("TANGGAL", "TAVG", "RR", "FF_AVG")
data$TANGGAL <- as.Date(data$TANGGAL, format = "%d-%m-%Y")

# ambil kolom yang ingin diuji saja
subset_data <- data[, c("TANGGAL", "TAVG")]

head(subset_data)
```

## Eksplorasi Data

```{r}
View(subset_data)
str(subset_data)
dim(subset_data)
```

```{r}
# cek data kosong
colSums(is.na(subset_data))
```

```{r}
# 8888: Data tidak terukur, 9999: Tidak Ada Data (tidak dilakukan pengukuran)
subset(subset_data, TAVG == 8888 | TAVG == 9999 | TAVG == "-")
```

Mengubah data agar terbaca sebagai data deret waktu dengan fungsi `ts()` .

```{r}
data.ts <- ts(subset_data$TAVG)
data.ts
```

Menampilkan ringkasan data

```{r}
summary(data.ts)
```

Membuat plot data deret waktu

```{r}
ts.plot(data.ts, xlab="Time Period ", ylab="TAVG", 
        main = "Time Series Plot")
points(data.ts)
```

## Pembagian Data

Pembagian data latih dan data uji dilakukan dengan perbandingan 80% data latih dan 20% data uji.

```{r}
# hitung jumlah data
n <- nrow(subset_data)

# tentukan batas 80%
n_train <- floor(0.8 * n)

# bagi data
training <- subset_data[1:n_train, ]
testing  <- subset_data[(n_train+1):n, ]

# ubah ke time series
train.ts <- ts(training$TAVG)
test.ts  <- ts(testing$TAVG)
```

Eksplorasi data dilakukan pada keseluruhan data, data latih serta data uji menggunakan plot data deret waktu.

```{r}
#eksplorasi keseluruhan data
plot(data.ts, col="red",main="Plot semua data")
points(data.ts)

#eksplorasi data latih
plot(train.ts, col="blue",main="Plot data latih")
points(train.ts)

#eksplorasi data uji
plot(test.ts, col="blue",main="Plot data uji")
points(test.ts)
```

# Forecast tiap model

## Single Moving Average (SMA)

```{r}
data.sma<-SMA(train.ts, n=4)
data.sma
```

```{r}
data.ramal<-c(NA,data.sma)
data.ramal #forecast 1 periode ke depan
```

dilakukan peramalan sebanyak 25 periode sesuai dengan jumlah data uji.

```{r}
data.gab<-cbind(
  aktual=c(data.ts),
  pemulusan=c(data.sma,rep(NA,25)),
  ramalan=c(data.ramal,rep(data.ramal[length(data.ramal)],24)))

head(data.gab, 10)
```

Adapun plot data deret waktu dari hasil peramalan yang dilakukan adalah sebagai berikut.

```{r}
ts.plot(data.ts, xlab="Time Period ", ylab="TAVG", main= "SMA N=4 Data TAVG")
points(data.ts)
lines(data.gab[,2],col="green",lwd=2)
lines(data.gab[,3],col="red",lwd=2)
legend("topleft",c("data aktual","data pemulusan","data peramalan"), lty=8, col=c("black","green","red"), cex=0.5)
```

```{r}
#Menghitung nilai keakuratan data latih
error_train.sma = train.ts-data.ramal[1:length(train.ts)]

SSE_train.sma = sum(error_train.sma[5:length(train.ts)]^2)
MSE_train.sma = mean(error_train.sma[5:length(train.ts)]^2)
MAPE_train.sma = mean(abs((error_train.sma[5:length(train.ts)]/train.ts[5:length(train.ts)])*100))

akurasi_train.sma <- matrix(c(SSE_train.sma, MSE_train.sma, MAPE_train.sma))
row.names(akurasi_train.sma)<- c("SSE", "MSE", "MAPE")
colnames(akurasi_train.sma) <- c("Akurasi m = 4")
akurasi_train.sma
```

Dalam hal ini nilai MAPE data latih pada metode pemulusan SMA sekitar 2,5%. Selanjutnya dilakukan perhitungan nilai MAPE data uji pada metode pemulusan SMA.

```{r}
#Menghitung nilai keakuratan data uji
error_test.sma = test.ts-data.gab[101:125,3]

SSE_test.sma = sum(error_test.sma^2)
MSE_test.sma = mean(error_test.sma^2)
MAPE_test.sma = mean(abs((error_test.sma/test.ts*100)))

akurasi_test.sma <- matrix(c(SSE_test.sma, MSE_test.sma, MAPE_test.sma))
row.names(akurasi_test.sma)<- c("SSE", "MSE", "MAPE")
colnames(akurasi_test.sma) <- c("Akurasi m = 4")
akurasi_test.sma
```

Perhitungan akurasi menggunakan data latih menghasilkan nilai MAPE yang kurang dari 10% sehingga nilai akurasi ini dapat dikategorikan sebagai sangat baik.

## Double Moving Average (DMA)

```{r}
dma <- SMA(data.sma, n = 4)
At <- 2*data.sma - dma
Bt <- 2/(4-1)*(data.sma - dma)
data.dma<- At+Bt
data.ramal2<- c(NA, data.dma)

t = 1:25
f = c()

for (i in t) {
  f[i] = At[length(At)] + Bt[length(Bt)]*(i)
}

data.gab2 <- cbind(aktual = c(data.ts), 
                   pemulusan1 = c(data.sma,rep(NA,25)),
                   pemulusan2 = c(dma, rep(NA,25)),
                   At = c(At, rep(NA,25)), 
                   Bt = c(Bt,rep(NA,25)),
                   ramalan = c(data.ramal2, f[-1]))

head(data.gab2, 10)

```

Hasil pemulusan menggunakan metode DMA divisualisasikan sebagai berikut

```{r}
ts.plot(data.ts, xlab="Time Period ", ylab="TAVG", main= "DMA N=4 Data TAVG")
points(data.ts)
lines(data.gab2[,3],col="green",lwd=2)
lines(data.gab2[,6],col="red",lwd=2)
legend("topleft",c("data aktual","data pemulusan","data peramalan"), lty=8, col=c("black","green","red"), cex=0.8)

```

Selanjutnya perhitungan akurasi dilakukan baik pada data latih maupun data uji. Perhitungan akurasi dilakukan dengan ukuran akurasi SSE, MSE dan MAPE.

```{r}
#Menghitung nilai keakuratan data latih
error_train.dma = train.ts-data.ramal2[1:length(train.ts)]

SSE_train.dma = sum(error_train.dma[8:length(train.ts)]^2)
MSE_train.dma = mean(error_train.dma[8:length(train.ts)]^2)
MAPE_train.dma = mean(abs((error_train.dma[8:length(train.ts)]/train.ts[8:length(train.ts)])*100))

akurasi_train.dma <- matrix(c(SSE_train.dma, MSE_train.dma, MAPE_train.dma))
row.names(akurasi_train.dma)<- c("SSE", "MSE", "MAPE")
colnames(akurasi_train.dma) <- c("Akurasi m = 4")
akurasi_train.dma
```

Perhitungan akurasi pada data latih menggunakan nilai MAPE menghasilkan nilai MAPE yang kurang dari 10% sehingga dikategorikan sangat baik. Selanjutnya, perhitungan nilai akurasi dilakukan pada data uji.

```{r}
#Menghitung nilai keakuratan data uji
error_test.dma = test.ts-data.gab2[101:125,6]
SSE_test.dma = sum(error_test.dma^2)
MSE_test.dma = mean(error_test.dma^2)
MAPE_test.dma = mean(abs((error_test.dma/test.ts*100)))

akurasi_test.dma <- matrix(c(SSE_test.dma, MSE_test.dma, MAPE_test.dma))
row.names(akurasi_test.dma)<- c("SSE", "MSE", "MAPE")
colnames(akurasi_test.dma) <- c("Akurasi m = 4")
akurasi_test.dma

```

Pada data latih maupun uji, metode SMA lebih baik dibandingkan dengan metode DMA.

## Single Exponential Smoothing

```{r}
#Cara 1 (fungsi ses)
ses.1 <- ses(train.ts, h = 25, alpha = 0.2)
plot(ses.1)
ses.1

ses.2<- ses(train.ts, h = 25, alpha = 0.7)
plot(ses.2)
ses.2
```

```{r}
autoplot(ses.1) +
  autolayer(fitted(ses.1), series="Fitted") +
  ylab("TAVG") + xlab("Periode")
```

Selanjutnya akan digunakan fungsi `HoltWinters()` dengan nilai inisialisasi parameter dan panjang periode peramalan yang sama dengan fungsi `ses()` .

```{r}
#Cara 2 (fungsi Holtwinter)
ses1<- HoltWinters(train.ts, gamma = FALSE, beta = FALSE, alpha = 0.2)
plot(ses1)

#ramalan
ramalan1<- forecast(ses1, h=25)
ramalan1

ses2<- HoltWinters(train.ts, gamma = FALSE, beta = FALSE, alpha = 0.7)
plot(ses2)

#ramalan
ramalan2<- forecast(ses2, h=25)
ramalan2
```

```{r}
#SES
ses.opt <- ses(train.ts, h = 25, alpha = NULL)
plot(ses.opt)
ses.opt

#Lamda Optimum Holt Winter
HWopt<- HoltWinters(train.ts, gamma = FALSE, beta = FALSE,alpha = NULL)
HWopt
plot(HWopt)

#ramalan
ramalanopt<- forecast(HWopt, h=25)
ramalanopt
```

Setelah dilakukan peramalan, akan dilakukan perhitungan keakuratan hasil peramalan. Perhitungan akurasi ini dilakukan baik pada data latih dan data uji.

### Akurasi Data Latih

```{r}
#Keakuratan Metode
#Pada data training

# SES dengan alpha = 0.2
SSE1<-ses1$SSE
MSE1<-ses1$SSE/length(train.ts)
RMSE1<-sqrt(MSE1)

akurasi1 <- matrix(c(SSE1,MSE1,RMSE1))
row.names(akurasi1)<- c("SSE", "MSE", "RMSE")
colnames(akurasi1) <- c("Akurasi lamda=0.2")
akurasi1

# SES dengan alpha = 0.7
SSE2<-ses2$SSE
MSE2<-ses2$SSE/length(train.ts)
RMSE2<-sqrt(MSE2)

akurasi2 <- matrix(c(SSE2,MSE2,RMSE2))
row.names(akurasi2)<- c("SSE", "MSE", "RMSE")
colnames(akurasi2) <- c("Akurasi lamda=0.7")
akurasi2
```

Berdasarkan nilai SSE, MSE, RMSE, dan MAPE di antara kedua parameter, nilai parameter $\lambda=0,2$ menghasilkan akurasi yang lebih baik dibanding $\lambda=0,7$ . Hal ini dilihat dari nilai masing-masing ukuran akurasi yang lebih kecil. Berdasarkan nilai MAPE-nya, hasil ini dapat dikategorikan sebagai peramalan sangat baik.

### Akurasi Data Uji

```{r}
# jumlah observasi uji
n_test <- nrow(testing)

# error (ramalan - aktual), samakan panjang dan tipe numeric
e1   <- as.numeric(ramalan1$mean)[1:n_test] - as.numeric(testing$TAVG)
e2   <- as.numeric(ramalan2$mean)[1:n_test] - as.numeric(testing$TAVG)
eopt <- as.numeric(ramalanopt$mean)[1:n_test] - as.numeric(testing$TAVG)

# SSE / MSE / RMSE untuk masing-masing model (abaikan NA)
SSEtesting1  <- sum(e1^2,  na.rm = TRUE)
MSEtesting1  <- mean(e1^2, na.rm = TRUE)
RMSEtesting1 <- sqrt(MSEtesting1)

SSEtesting2  <- sum(e2^2,  na.rm = TRUE)
MSEtesting2  <- mean(e2^2, na.rm = TRUE)
RMSEtesting2 <- sqrt(MSEtesting2)

SSEtestingopt  <- sum(eopt^2,  na.rm = TRUE)
MSEtestingopt  <- mean(eopt^2, na.rm = TRUE)
RMSEtestingopt <- sqrt(MSEtestingopt)

# Tabel ringkas
akurasitesting_SSE <- matrix(c(SSEtesting1, SSEtesting2, SSEtestingopt),
                             nrow = 3,
                             dimnames = list(c("SSE1","SSE2","SSEopt"), "Nilai"))
akurasitesting_SSE

akurasitesting_MSE <- matrix(c(MSEtesting1, MSEtesting2, MSEtestingopt),
                             nrow = 3,
                             dimnames = list(c("MSE1","MSE2","MSEopt"), "Nilai"))
akurasitesting_MSE

akurasitesting_RMSE <- matrix(c(RMSEtesting1, RMSEtesting2, RMSEtestingopt),
                              nrow = 3,
                              dimnames = list(c("RMSE1","RMSE2","RMSEopt"), "Nilai"))
akurasitesting_RMSE
```

## *Double Exponential Smoothing* (DES)

```{r}
#Lamda=0.2 dan gamma=0.2
des.1<- HoltWinters(train.ts, gamma = FALSE, beta = 0.2, alpha = 0.2)
plot(des.1)

#ramalan
ramalandes1<- forecast(des.1, h=25)
ramalandes1

#Lamda=0.6 dan gamma=0.3
des.2<- HoltWinters(train.ts, gamma = FALSE, beta = 0.3, alpha = 0.6)
plot(des.2)

#ramalan
ramalandes2<- forecast(des.2, h=25)
ramalandes2
```

Selanjutnya jika ingin membandingkan plot data latih dan data uji adalah sebagai berikut.

```{r}
plot(data.ts)
lines(des.1$fitted[,1], lty=2, col="blue")
lines(ramalandes1$mean, col="red")
```

Untuk mendapatkan nilai parameter optimum dari DES, argumen `alpha` dan `beta` dapat dibuat `NULL` seperti berikut.

```{r}
#Lamda dan gamma optimum
des.opt<- HoltWinters(train.ts, gamma = FALSE)
des.opt
plot(des.opt)

#ramalan
ramalandesopt<- forecast(des.opt, h=25)
ramalandesopt
```

Selanjutnya akan dilakukan perhitungan akurasi pada data latih maupun data uji dengan ukuran akurasi SSE, MSE dan MAPE.

### Akurasi Data Latih

```{r}
#Akurasi Data Training
ssedes.train1<-des.1$SSE
msedes.train1<-ssedes.train1/length(train.ts)
sisaandes1<-ramalandes1$residuals
head(sisaandes1)

mapedes.train1 <- sum(abs(sisaandes1[3:length(train.ts)]/train.ts[3:length(train.ts)])
                      *100)/length(train.ts)

akurasides.1 <- matrix(c(ssedes.train1,msedes.train1,mapedes.train1))
row.names(akurasides.1)<- c("SSE", "MSE", "MAPE")
colnames(akurasides.1) <- c("Akurasi lamda=0.2 dan gamma=0.2")
akurasides.1

ssedes.train2<-des.2$SSE
msedes.train2<-ssedes.train2/length(train.ts)
sisaandes2<-ramalandes2$residuals
head(sisaandes2)

mapedes.train2 <- sum(abs(sisaandes2[3:length(train.ts)]/train.ts[3:length(train.ts)])
                      *100)/length(train.ts)

akurasides.2 <- matrix(c(ssedes.train2,msedes.train2,mapedes.train2))
row.names(akurasides.2)<- c("SSE", "MSE", "MAPE")
colnames(akurasides.2) <- c("Akurasi lamda=0.6 dan gamma=0.3")
akurasides.2
```

Hasil akurasi dari data latih didapatkan skenario 2 dengan lamda=0.6 dan gamma=0.3 memiliki hasil yang lebih baik. Namun untuk kedua skenario dapat dikategorikan peramalan sangat baik berdasarkan nilai MAPE-nya.

### Akurasi Data Uji

```{r}
#Akurasi Data Testing
selisihdes1<-ramalandes1$mean-testing$TAVG
selisihdes1

SSEtestingdes1<-sum(selisihdes1^2)
MSEtestingdes1<-SSEtestingdes1/length(testing$TAVG)
MAPEtestingdes1<-sum(abs(selisihdes1/testing$TAVG)*100)/length(testing$TAVG)

selisihdes2<-ramalandes2$mean-testing$TAVG
selisihdes2

SSEtestingdes2<-sum(selisihdes2^2)
MSEtestingdes2<-SSEtestingdes2/length(testing$TAVG)
MAPEtestingdes2<-sum(abs(selisihdes2/testing$TAVG)*100)/length(testing$TAVG)

selisihdesopt<-ramalandesopt$mean-testing$TAVG
selisihdesopt

SSEtestingdesopt<-sum(selisihdesopt^2)
MSEtestingdesopt<-SSEtestingdesopt/length(testing$TAVG)
MAPEtestingdesopt<-sum(abs(selisihdesopt/testing$TAVG)*100)/length(testing$TAVG)

akurasitestingdes <-
  matrix(c(SSEtestingdes1,MSEtestingdes1,MAPEtestingdes1,SSEtestingdes2,MSEtestingdes2,
           MAPEtestingdes2,SSEtestingdesopt,MSEtestingdesopt,MAPEtestingdesopt),
         nrow=3,ncol=3)
row.names(akurasitestingdes)<- c("SSE", "MSE", "MAPE")
colnames(akurasitestingdes) <- c("des ske1","des ske2","des opt")
akurasitestingdes
```

# Perbandingan SMA, DMA, ESE, DES

```{r}
akurasi_final <-
  matrix(c(SSE_test.sma, MSE_test.sma,
           SSE_test.dma, MSE_test.dma,
           SSEtesting1, MSEtesting1,
           SSEtesting2, MSEtesting2,
           SSEtestingopt, MSEtestingopt,
           SSEtestingdes1, MSEtestingdes1,
           SSEtestingdes2, MSEtestingdes2,
           SSEtestingdesopt, MSEtestingdesopt),nrow=8,ncol=2)
row.names(akurasi_final)<- c("SMA", "DMA", "SES 0,2", "SES 0,7", "SES OPT", "DES 0,2", "DES 0,6", "DES OPT")
colnames(akurasi_final) <- c("SSE","MSE")
akurasi_final
```

Dari keempat metode dapat dilihat metode DMA memiliki hasil yang paling baik, karena kedua nilai SSE dan MSE-nya merupakan yang terkecil dari semua metode yang dicoba.
